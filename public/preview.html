<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Website Options - SpokenSite</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #1e293b;
      --surface: #334155;
      --accent: #14b8a6;
      --accent-glow: #2dd4bf;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --cream: #f8fafc;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .header { padding: 2rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .header h1 { font-family: 'Instrument Serif', serif; font-size: 2.5rem; color: var(--cream); margin-bottom: 0.5rem; }
    .header p { color: var(--text-muted); font-size: 1.1rem; }
    .business-name { color: var(--accent); font-weight: 600; }
    .tabs { display: flex; justify-content: center; gap: 1rem; padding: 2rem; background: var(--surface); flex-wrap: wrap; }
    .tab { padding: 1rem 2rem; background: transparent; border: 2px solid var(--text-muted); border-radius: 100px; color: var(--text); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .tab:hover { border-color: var(--accent); color: var(--accent); }
    .tab.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .preview-container { padding: 2rem; }
    .preview-frame { width: 100%; height: calc(100vh - 300px); min-height: 600px; border: none; border-radius: 12px; background: white; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .actions { display: flex; justify-content: center; gap: 1rem; padding: 2rem; background: var(--surface); flex-wrap: wrap; }
    .btn { padding: 1rem 2rem; border-radius: 100px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; border: none; }
    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-primary:hover { background: var(--accent-glow); transform: translateY(-2px); }
    .btn-secondary { background: transparent; color: var(--text); border: 2px solid var(--text-muted); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; gap: 1.5rem; }
    .spinner { width: 60px; height: 60px; border: 4px solid var(--surface); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 1.2rem; color: var(--text-muted); }
    .hidden { display: none !important; }
    .error { color: #ef4444; text-align: center; padding: 2rem; }
  </style>
</head>
<body>
  <div id="loading-view" class="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading your website designs...</div>
  </div>

  <div id="preview-view" class="hidden">
    <div class="header">
      <h1>Your Website Options</h1>
      <p>We created 3 unique designs for <span class="business-name" id="displayBusinessName">your business</span></p>
    </div>
    <div class="tabs">
      <button class="tab active" data-style="modern" onclick="switchTab('modern')">?? Modern & Bold</button>
      <button class="tab" data-style="classic" onclick="switchTab('classic')">??? Classic & Professional</button>
      <button class="tab" data-style="warm" onclick="switchTab('warm')">?? Warm & Inviting</button>
    </div>
    <div class="preview-container">
      <iframe id="previewFrame" class="preview-frame"></iframe>
    </div>
    <div class="actions">
      <button class="btn btn-secondary" onclick="downloadCurrent()">Download This Design</button>
      <button class="btn btn-secondary" onclick="downloadAll()">Download All 3</button>
      <button class="btn btn-primary" onclick="selectDesign()">I Want This One!</button>
    </div>
  </div>

  <div id="error-view" class="hidden">
    <div class="header">
      <h1>Oops!</h1>
      <p class="error" id="errorMessage">Something went wrong</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kdeujojzurjswwmbfgdv.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_4oIqXmgK7MW3PM5KPdB6QA_ZjNV22xB';
    
    let generatedWebsites = null;
    let currentStyle = 'modern';
    let businessName = '';

    async function loadFromSupabase(id) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/generated_sites?id=eq.${id}&select=*`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        if (!data || data.length === 0) throw new Error('No sites found for this ID');
        
        const site = data[0];
        generatedWebsites = {
          modern: site.modern_html,
          classic: site.classic_html,
          warm: site.warm_html
        };
        businessName = site.business_info?.businessName || 'your business';
        
        return true;
      } catch (error) {
        console.error('Supabase error:', error);
        return false;
      }
    }

    function showPreview() {
      document.getElementById('loading-view').classList.add('hidden');
      document.getElementById('error-view').classList.add('hidden');
      document.getElementById('preview-view').classList.remove('hidden');
      document.getElementById('displayBusinessName').textContent = businessName;
      switchTab('modern');
    }

    function showError(message) {
      document.getElementById('loading-view').classList.add('hidden');
      document.getElementById('preview-view').classList.add('hidden');
      document.getElementById('error-view').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    function switchTab(style) {
      currentStyle = style;
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.style === style);
      });
      const frame = document.getElementById('previewFrame');
      frame.srcdoc = generatedWebsites[style];
    }

    function downloadCurrent() {
      const html = generatedWebsites[currentStyle];
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${businessName.replace(/\s+/g, '-').toLowerCase()}-${currentStyle}.html`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadAll() {
      ['modern', 'classic', 'warm'].forEach(style => {
        const html = generatedWebsites[style];
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${businessName.replace(/\s+/g, '-').toLowerCase()}-${style}.html`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function selectDesign() {
      alert(`Great choice! The ${currentStyle} design for ${businessName} has been selected.\n\nWe'll be in touch to finalize and deploy your new website!`);
    }

    // Init
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      
      if (id) {
        const loaded = await loadFromSupabase(id);
        if (loaded) {
          showPreview();
        } else {
          showError('Could not find your website designs. Please check the link or contact support.');
        }
      } else {
        showError('No design ID provided. Please use the link from your email.');
      }
    }

    init();
  </script>
</body>
</html>
